"""Progress tracking for async operations."""

import asyncio
import sys
from typing import Optional


class ProgressBar:
    """Simple progress bar for async operations."""

    def __init__(self, file_size: int, desc: str = "Analyzing"):
        """
        Initialize progress bar.

        Args:
            file_size: Size of file in bytes (used to estimate duration)
            desc: Description to show
        """
        self.file_size = file_size
        self.desc = desc
        self.task: Optional[asyncio.Task] = None
        self.done = False

        # Estimate duration based on file size
        # Small files: ~5 seconds
        # Medium files (1-10MB): ~15 seconds
        # Large files (>10MB): ~30 seconds
        if file_size < 1_000_000:  # < 1MB
            self.estimated_duration = 5.0
        elif file_size < 10_000_000:  # < 10MB
            self.estimated_duration = 15.0
        else:
            self.estimated_duration = 30.0

    async def _show_progress(self):
        """Show animated progress bar."""
        chars = ["⠋", "⠙", "⠹", "⠸", "⠼", "⠴", "⠦", "⠧", "⠇", "⠏"]
        idx = 0
        elapsed = 0.0
        interval = 0.1

        while not self.done:
            # Calculate progress percentage
            progress = min(elapsed / self.estimated_duration, 0.99)
            bar_length = 40
            filled = int(bar_length * progress)
            bar = "█" * filled + "░" * (bar_length - filled)

            # Show progress
            percent = int(progress * 100)
            spinner = chars[idx % len(chars)]

            sys.stderr.write(f"\r{spinner} {self.desc}: [{bar}] {percent}%")
            sys.stderr.flush()

            await asyncio.sleep(interval)
            elapsed += interval
            idx += 1

        # Clear the line when done
        sys.stderr.write("\r" + " " * 80 + "\r")
        sys.stderr.flush()

    def start(self):
        """Start showing progress."""
        self.done = False
        self.task = asyncio.create_task(self._show_progress())

    async def stop(self):
        """Stop showing progress."""
        self.done = True
        if self.task:
            await self.task


async def run_with_progress(file_path: str, file_size: int, coro):
    """
    Run a coroutine with progress indication.

    Args:
        file_path: Path to file being analyzed
        file_size: Size of file in bytes
        coro: Coroutine to run

    Returns:
        Result of coroutine
    """
    from pathlib import Path
    filename = Path(file_path).name

    progress = ProgressBar(file_size, f"Analyzing {filename}")
    progress.start()

    try:
        result = await coro
    finally:
        await progress.stop()

    return result
